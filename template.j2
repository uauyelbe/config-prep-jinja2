Current configuration : 9546 bytes
!
! Last configuration change at 09:52:36 ALM Thu Jul 5 2018 by bankomat
!
cellular 0 lte profile create 1 kaspi chap {{ kcell_name }} {{ kcell_pass }} ipv4
!
cellular 0 lte profile create 2 kaspi.tele2.kz chap {{ tele2_name }} {{ tele2_pass }} ipv4
!
no service pad
service tcp-keepalives-in
service tcp-keepalives-out
service timestamps debug datetime msec localtime show-timezone
service timestamps log datetime msec localtime show-timezone
service password-encryption
service sequence-numbers
!
hostname {{ hostname }}
!
boot-start-marker
boot-end-marker
!
!
logging buffered 256300 informational
no logging console
no logging monitor
enable secret DslfqLtytu20!8
!
no aaa new-model
clock timezone ALM 6 0
!
no ip source-route
!
!
!
!
!
!
!
!
!
!


!
ip dhcp bootp ignore
!
!
!
no ip bootp server
no ip domain lookup
ip domain name bc.kz
ip cef
login block-for 60 attempts 2 within 30
login on-failure log every 2
login on-success log
no ipv6 cef
!
multilink bundle-name authenticated
!
!
domain bc.kz
!
key config-key password-encrypt KaspiKey2018
!
chat-script GSM "" "AT!SCACT=1,1" TIMEOUT 60 "OK"
password encryption aes
!
!
!
!
username bankomat secret RhfcyfzRjhj,rf20!8
!
redundancy
!
crypto ikev2 dpd 16 2 period
!
crypto ikev2 proposal ATM
 encryption aes-cbc-256
 integrity sha256
 group 16
!
crypto ikev2 policy ATM
 match fvrf any
 proposal ATM
!
crypto ikev2 keyring KEY-ATM
 peer HQ1
  address 10.1.156.4
  pre-shared-key Do2IDpbP9YOBAOXbw5VjGYctqHHmACoP
!
 peer HQ2
  address 10.1.156.2
  pre-shared-key Do2IDpbP9YOBAOXbw5VjGYctqHHmACoP
 !
!
!
crypto ikev2 profile ATM
 match identity remote address 10.1.156.0 255.255.255.248
 authentication remote pre-share
 authentication local pre-share
 keyring local KEY-ATM
!
!
!
controller Cellular 0
 lte sim data-profile 1 attach-profile 1 slot 0
 lte sim data-profile 2 attach-profile 2 slot 1
 lte failovertimer 5
 no lte modem link-recovery disable
 lte modem link-recovery rssi onset-threshold -95
 lte modem link-recovery monitor-timer 20
 lte modem link-recovery wait-timer 10
 lte modem link-recovery debounce-count 6
no cdp run
!
!
!
!
crypto ipsec transform-set AES256-SHA256 esp-aes 256 esp-sha256-hmac
 mode tunnel
!
crypto ipsec profile ATM
 set transform-set AES256-SHA256
 set ikev2-profile ATM
!
!
!
!
!
!
!
!
interface Tunnel0
 description TO-HQ
 ip address {{ tunn_ip }} 255.255.254.0
 no ip redirects
 ip mtu 1432
 ip nhrp authentication kaspivp4
 ip nhrp map multicast 10.1.156.4
 ip nhrp map multicast 10.1.156.2
 ip nhrp map 10.2.230.1 10.1.156.4
 ip nhrp map 10.2.231.254 10.1.156.2
 ip nhrp network-id 77
 ip nhrp holdtime 300
 ip nhrp nhs 10.2.230.1
 ip nhrp nhs 10.2.231.254
 ip ospf message-digest-key 1 md5 Ghrt45Vbf
 ip ospf network point-to-multipoint
 delay 600000
 qos pre-classify
 tunnel source Cellular0
 tunnel mode gre multipoint
 tunnel key 6581648
 tunnel protection ipsec profile ATM
!
interface GigabitEthernet0
 description atm154-LAN
 ip address {{ int_ip }} 255.255.255.252
 ip access-group ATM-IN in
 ip virtual-reassembly in
 ip tcp adjust-mss 1392
 no shut
 duplex auto
 speed auto
!
interface GigabitEthernet1
 no ip address
 shutdown
 duplex auto
 speed auto
!
interface GigabitEthernet2
 no ip address
 shutdown
 duplex auto
 speed auto
!
!
!
!
router ospf 35673
 router-id {{ router_id }}
 area 15 authentication message-digest
 area 15 stub no-summary
 passive-interface default
 no passive-interface Tunnel0
 network {{ p2p_net }} 0.0.0.3 area 15
 network 10.2.230.0 0.0.1.255 area 15
!
ip forward-protocol nd
!
no ip http server
no ip http secure-server
!
crypto key generate rsa
2048
!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!
ip route 10.1.156.2 255.255.255.255 Cellular0
ip route 10.1.156.4 255.255.255.255 Cellular0
ip ssh maxstartups 2
ip ssh time-out 60
ip ssh authentication-retries 2
ip ssh version 2
ip scp server enable
!
ip access-list extended ATM-IN
 deny   tcp any any eq 445 log
 deny   tcp any any eq 593
 deny   udp any any eq 445
 deny   udp any any eq 593
 deny   tcp any eq 445 any log
 deny   tcp any eq 593 any
 deny   udp any eq 445 any
 deny   udp any eq 593 any
 deny   tcp any any eq 9996
 deny   tcp any any eq 5554
 deny   tcp any eq 5554 any
 deny   tcp any eq 9996 any
 deny   tcp any any eq 1022
 deny   tcp any any eq 1023
 deny   udp any any eq netbios-ns
 permit tcp any any eq telnet
 permit tcp any host 10.1.3.146 eq 21001
 permit tcp any host 10.17.145.234 eq 29833
 permit tcp any host 172.26.0.36 eq 29833
 permit tcp any eq 2121 host 10.17.161.162 established
 permit tcp any eq 2121 host 10.17.161.163 established
 permit tcp any eq 2121 host 172.26.9.10 established
 permit tcp any eq 2121 host 172.26.9.11 established
 permit tcp any host 172.26.0.10 eq 443
 permit tcp any host 172.26.0.50 eq 443
 permit udp any host 10.17.161.66 eq domain
 permit udp any host 10.17.161.82 eq domain
 permit udp any host 172.26.29.2 eq domain
 permit udp any host 172.26.29.3 eq domain
 permit tcp any host 172.26.29.2 eq domain
 permit tcp any host 172.26.29.3 eq domain
 deny   ip any any log

!
ip sla 1
 icmp-echo 10.1.156.4 source-interface Cellular0
 timeout 10000
 frequency 15
ip sla schedule 1 life forever start-time now
ip sla 10
 icmp-echo 10.2.230.1 source-interface Tunnel0
 timeout 10000
ip sla schedule 10 life forever start-time now
!
kron policy-list reload-weekly
 cli reload
!
kron occurrence reload-weekly at 3:00 Mon recurring
 policy-list reload-weekly
!

track 10 ip sla 10
 delay down 180 up 2
!

!
logging source-interface Tunnel0
logging host 10.17.34.210
dialer watch-list 1 ip 10.1.156.4 255.255.255.255
dialer watch-list 1 delay route-check initial 15
dialer watch-list 1 delay connect 1
dialer-list 1 protocol ip permit
dialer-list 1 protocol ipv6 permit
ipv6 ioam timestamp
!
!
access-list 1 permit any
access-list 23 permit 10.100.99.0 0.0.0.255
access-list 23 permit 10.28.0.0 0.0.0.63
!
control-plane
!
interface Cellular0
 ip address negotiated
 ip virtual-reassembly in
 encapsulation slip
 dialer in-band
 dialer idle-timeout 0
 dialer string lte
 dialer string GSM
 dialer watch-group 1
 dialer-group 1
 ipv6 address autoconfig
 async mode interactive
!
access-list 3 permit 10.17.27.40
!
snmp-server view V3read iso included
snmp-server group Zabbix v3 priv read V3read access 3
snmp-server user Zabbix Zabbix v3 auth sha zaBBixShmabix priv aes 128 qRst5hKlm access 3
!
no vstack
banner login ^CCC
****************************************************************
* [WARNING]                                                    *
* This system is owned by Kaspi Bank JSC.                      *
* If you are not authorized to access this system, exit        *
* immediately.                                                 *
* Unauthorized access to this system is forbiden by company    *
* policies, national, and international laws.                  *
* Unauthorized users are subject to criminal and civil         *
* penalties as well as company initiated disciplinary          *
* proceedings.                                                 *
*                                                              *
* By entry into this system you acknowledge that you are       *
* authorized access and the level of privilege you subsequently*
* execute on this system. You further acknowledge that by entry*
* into this system you expect no privacy from monitoring.      *
****************************************************************
^C
!
line con 0
 session-timeout 10
 exec-timeout 5 0
 logging synchronous
 stopbits 1
 no privilege level 15
line vty 0 4
 session-timeout 10
 access-class 23 in
 exec-timeout 5 0
 login local
 transport input ssh
 no privilege level 15
!
no scheduler max-task-time
ntp server 10.17.161.130 prefer
ntp server 10.17.161.131
ntp server 10.70.3.36
no iox hdm-enable
iox client enable interface GigabitEthernet2
no iox recovery-enable
!
!
!

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!
controller Cellular 0
 lte sim primary slot 1
 lte failovertimer 5
 no lte modem link-recovery disable
 lte modem link-recovery rssi onset-threshold -95
 lte modem link-recovery monitor-timer 20
 lte modem link-recovery wait-timer 10
 lte modem link-recovery debounce-count 6
!
!
!
event manager applet Check-track
 event timer watchdog time 600
 action 1.10 cli command "enable"
 action 1.11 cli command "show track 10 | in State is"
 action 1.12 regexp "State is Up" "$_cli_result"
 action 1.14 if $_regexp_result eq "1"
 action 1.15  syslog msg "Track is Up. Tunnel is work"
 action 2.11 else
 action 2.12  syslog msg "Track is Down. Switch to backup SIM"
 action 2.13  track read 10
 action 2.14  if $_track_state eq "down"
 action 2.15   cli command "enable"
 action 2.16   cli command "show cellular 0 network | in Network ="
 action 2.17   regexp "Network = 145-002" "$_cli_result"
 action 2.18   if $_regexp_result eq "1"
 action 2.19    syslog msg "KCELL Network Issue. Switching to TELE2"
 action 2.20    cli command "clear interface cellular 0"
 action 2.21    cli command "cellular 0 lte sim activate slot 1"
 action 2.22   else
 action 2.23    syslog msg "TELE2 Network Issue. Switching to Kcell"
 action 2.25    cli command "clear interface cellular "
 action 2.26    cli command "cellular 0 lte sim activate slot 0"
 action 2.27   end
 action 2.28   cli command "do clear ip route *"
 action 2.29   cli command "do show ip sla statistics"
 action 2.30   cli command "do show ip route"
 action 2.31   cli command "do show ip interface brief"
 action 2.32  end
 action 2.33 end
event manager applet SIM_Toggle
 event tag e1 track 10 state down
 event tag e2 timer countdown time 120
 trigger
  correlate event e1 or event e2
 action 1.0 track read 10
 action 1.1 if $_track_state eq "down"
 action 1.2  cli command "enable"
 action 1.3  cli command "show cellular 0 network | in Network ="
 action 1.4  regexp "Network = 145-002" "$_cli_result"
 action 1.5  if $_regexp_result eq "1"
 action 1.6   syslog msg "KCELL Network Issue. Switching to TELE2"
 action 1.7   cli command "clear interface cellular 0"
 action 1.8   cli command "cellular 0 lte sim activate slot 1"
 action 2.0  else
 action 2.1   syslog msg "TELE2 Network Issue. Switching to Kcell"
 action 2.2   cli command "clear interface cellular "
 action 2.3   cli command "cellular 0 lte sim activate slot 0"
 action 2.4  end
 action 2.5  cli command "do clear ip route *"
 action 2.6  cli command "do show ip sla statistics"
 action 2.7  cli command "do show ip route"
 action 2.8  cli command "do show ip interface brief"
 action 2.9 end
event manager applet Failback-Kcell
 event timer cron cron-entry "10 4 * * *"
 action 1.10 cli command "enable"
 action 1.11 cli command "show cellular 0 network | in Network ="
 action 1.12 regexp "Network = 145-002" "$_cli_result"
 action 1.13 if $_regexp_result eq "1"
 action 1.14  syslog msg "Activating TELE2 Sim Card"
 action 1.15  cli command "clear interface cellular "
 action 1.16  cli command "cellular 0 lte sim activate slot 1"
 action 1.17  cli command "do clear ip route *"
 action 1.18  cli command "do show ip sla statistics"
 action 1.19  cli command "do show ip route"
 action 1.21  cli command "do show ip interface brief"
 action 2.1  else
 action 2.2   syslog msg "Connection on TELE2"
 action 2.3  end


!
end

!!!!Pass-Encrypt!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!key config-key password-encrypt KaspiKey2018
!password encryption aes
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!Profile create!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! cellular 0 lte profile create 1 kaspi chap atm154-54@bc password ipv4
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
